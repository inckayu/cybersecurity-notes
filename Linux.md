# SSH

```bash
ssh USER_NAME@IP_ADDRESS

# デフォルトのポート(22)ではない場合
ssh USER_NAME@IP_ADDRESS -p PORT_NUMBER
```
## オプション

| オプション       | 説明                                     | 使用例                                                |
| ----------- | -------------------------------------- | -------------------------------------------------- |
| `-l`        | 接続時に指定するリモートのユーザー名を明示                  | `ssh -l user example.com`                          |
| `-p`        | ポート番号を引数に取る                            | `ssh -p 2222 user@example.com`                     |
| `-i`        | 秘密鍵ファイルを引数に取る                          | `ssh -i ~/.ssh/id_rsa user@example.com`            |
| `-v`        | デバッグ情報を詳細に出力                           | `ssh -v user@example.com`                          |
| `-C`        | データ圧縮を有効にして転送速度を向上                     | `ssh -C user@example.com`                          |
| `-N`        | コマンドやリモートシェルを実行せず、ポートフォワーディングのみ実行      | `ssh -N -L 8080:localhost:80 user@example.com`     |
| `-L`        | ローカルポートフォワーディングを設定                     | `ssh -L 8080:localhost:80 user@example.com`        |
| `-R`        | リモートポートフォワーディングを設定                     | `ssh -R 8080:localhost:80 user@example.com`        |
| `-f`        | SSHセッションをバックグラウンドで実行                   | `ssh -f -N -L 8080:localhost:80 user@example.com`  |
| `-T`        | ターミナル割り当てを無効化します                       | `ssh -T user@example.com`                          |
| `-q`        | 接続時のエラーメッセージを非表示                       | `ssh -q user@example.com`                          |
| `-4` / `-6` | IPv4またはIPv6を強制的に使用                     | `ssh -4 user@example.com`                          |
| `-X`        | X11転送を有効にします（リモートアプリケーションのGUIをローカルで表示） | `ssh -X user@example.com`                          |
| `-Y`        | `-X` の強化版。セキュリティ制限を緩和して機能性を優先する。       |                                                    |
| `-o`        | SSH設定ファイルにあるオプションを上書きして指定              | `ssh -o StrictHostKeyChecking=no user@example.com` |
| `-E`        | SSHのログを指定したファイルに出力します                  | `ssh -E ssh.log user@example.com`                  |

通常 `-f` と `-N` は併用する。
`-X` オプションを用いることでリモートのGUIアプリケーションをローカルで操作可能にする。ただしローカルマシンにXサーバーがインストールされていることとリモート環境でDISPLAY環境変数が設定されていることが必要。
公開鍵暗号を用いたSSH接続の際に `sign_and_send_pubkey: no mutual signature supported` のようなエラーが出る場合は以下のオプションを付与して解消。
```bash
ssh -o 'PubkeyAcceptedKeyTypes +ssh-rsa' -i rsa_key ...
```
`command-line line 0: no argument after keyword "pubkeyacceptedkeytypes"`というエラーが出る場合は以下のオプション。
```bash
ssh -oHostKeyAlgorithms=+ssh-rsa -oPubkeyAcceptedAlgorithms=+ssh-rsa  -i rsa_key ...
```
## SSHポートフォワーディング

[sshトンネリング](https://www.atmos.rcast.u-tokyo.ac.jp/fogawa/topics/unix/ssh_tunnelling.html)

## ローカルフォワード

ローカルから直接アクセスできるのはリモートであるが、リモートのみからアクセスできる攻撃対象にローカルからアクセスしたい。アクセス元をリモートからローカルへ移転(フォワード)する。

攻撃対象のポートを、リモートを経由して安全にローカルにつなぐ。

```bash
# ローカルで実行
ssh -L LOCAL_PORT:ATTACKED_IP:ATTACKED_PORT REMOTE_USERNAME@REMOTE_IP
```
## 仮想マシンからアクセスできるホストをローカルにポートフォワード
仮想マシンの `/etc/hosts` にホストのドメインを追記。
```bash
10.10.10.xx xxx.htb
```
ローカルマシンでポートフォワードを実行
```bash
ssh kali -L 8080:xxx.htb:80 -L 8443:xxx.htb:443
```
ローカルマシンの `/etc/hosts` にホストのドメインを追記
```bash
127.0.0.1 xxx.htb
```
ローカルマシンのブラウザで `xxx.htb` とポートを指定してアクセスできる。
### well knownポートのバインド
`xxx.htb`に矯正リダイレクトされるようなwebページにkaliからローカルにポートフォワードしてアクセスするにはローカルのポートは8080などではなく80(443)を割り当てる必要がある。ただしwell knownポート(0~1023)の割当てにはroot権限が必要なことに注意。またリモートのユーザ名も明示しておく必要がある。
```bash
sudo ssh -l kali kali -L 80:xxx.htb:80
```
## リモートフォワード
ローカルから直接アクセスできるのは攻撃対象であるが、ローカルからのみアクセスできる攻撃対象にリモートからアクセスしたい。アクセス元をローカルからリモートへ移転(フォワード)する。
攻撃対象のポートを、ローカルを経由して安全にリモートにつなぐ。
```bash
# ローカルで実行
ssh -R REMOTE_PORT:ATTACKED_IP:ATTACKED_PORT REMOTE_USERNAME@REMOTE_IP
```
## ダイナミックフォワード
ローカルからリモート側ネットワークのあらゆるポートにアクセスする。指定したローカルポートがプロキシとして機能する。ローカルのブラウザでフォワードしたリモートにアクセスする場合はプロキシでSOCKSの設定をする必要がある。
```bash
ssh -D LOCAL_PORT REMOTE_USERNAME@REMOTE_IP
```
# SCP

Secure CoPy.

リモート間でファイルを安全に転送するコマンド。SSHを用いて暗号化された通信を行う。SSHによる通信ができることが前提。

```bash
scp OPTIONS COPIED_FROM COPY_TO
```

利用例

```bash
# リモートサーバからローカルにファイルをコピー
scp user@remote_host:/path/to/remote/file /path/to/local/destination

# ローカルからリモートサーバにファイルをコピー
scp /path/to/local/file user@remote_host:/path/to/remote/destination
```

オプション

| オプション | 説明             |
| ----- | -------------- |
| -r    | ディレクトリを再帰的にコピー |
| -P    | ポート番号を引数に取る    |
| -l    | 転送速度を制限(kbps)  |
| -C    | 圧縮して転送         |
| -v    | 冗長モード          |
# FIND

名前の通り。検索の際はサブディレクトリ内も含む。

```bash
# 現在のディレクトリにおいて"flag1.txt"という名前のファイルを探す
find . -name flag1.txt

# /homeディレクトリにおいて"flag1.txt"という名前のファイルを探す
find /home -name flag1.txt

# /ディレクトリにおいてconfigという名前のディレクトリを探す
find / -type d -name config

# 777パーミッションのファイルを探す
find / -type f -perm 0777

# 実行可能ファイルを探す
find / -perm a=x

# /homeディレクトリにおいてfrankユーザのファイルを探す
find /home -user frank

# 過去10日間に修正されたファイルを探す
find / -mtime 10

# 過去10日間にアクセスされたファイルを探す
find / -atime 10

# 過去60分間に変更されたファイルを探す
find / -cmin -60

# 過去60分間にアクセスされたファイルを探す
find / -amin -60

# 50メガのファイルを探す
find / -size 50M

# SUIDファイルを探す
find / -type f -perm -4000 -ls 2> /dev/null

# SUIDとSGIDを同時に探す
# \\()\\の中では-oフラグ(OR)を用いてオプションの引数を複数取れる
find / -type f \\( -perm -4000 -o -perm -2000\\) 2> /dev/null
```

| オプション  | 説明                                                  |
| ------ | --------------------------------------------------- |
| -name  | 引数にファイル名を取る                                         |
| -iname | 大文字小文字を区別せずに名前を指定                                   |
| -type  | 引数にファイル(f)またはディレクトリ(d)を取る。デフォルトはf?                  |
| -user  | 引数にユーザを指定                                           |
| -mtime | 引数に現在から遡って修正があった期間(日)を取る                            |
| -atime | 引数に現在から遡ってアクセスがあった期間(日)を取る                          |
| -cmin  | 引数に現在から遡って変更があった期間(分)を取る                            |
| -amin  | 引数に現在から遡ってアクセスがあった期間(分)を取る                          |
| -size  | 引数にファイルの容量(c, k, M, G)を取る。下限の場合は数字の前に+、上限の場合は-をつける。 |
| -perm  | 引数にパーミッションを指定                                       |
| -group | グループを指定                                             |
`-perm` オプションは引数にパーミッションをオクタル形式で取ることができる。ただしオクタル表記の先頭に `-` をつけると(e.g. `-644` )少なくともその権限を持つものを検索できる(AND)。また先頭に `/` をつけると(e.g. `/222` )指定されたモードのどれか一つでも設定されているファイルを探す(OR)。 また特別な権限を検索することもできる。 `-perm -u=s` とすればSUIDが設定されているファイルを検索できる。 `-perm -g=s` とすればSGIDが設定されているファイルを検索できる。 `-perm -u=t` とすればスティッキービット(自分が所有するファイルのみ削除または名前変更が可能)が設定されているファイルを検索できる。
ファイル検索の際にはしばしばエラーが起きるので `2>/dev/null` を末尾につけてエラー出力は非表示(リダイレクト)した方が良い。
## -exec

```bash
find PATH -name NAME -exec COMMAND {} \\;
```

`find` で見つかったファイルやディレクトリは `{}` に挿入される。 `\\;` は `-exec` の終わりを示す( `;` はシェルで特殊文字なのでエスケープする必要がある)。

```bash
# 例: 見つけたファイルを削除する
find PATH -name "*.log" -exec rm {} \\;

# 例: 通常-execはファイルを1つずつ処理するが、+を使うことで複数のファイルを一度に処理することができる
find PATH -name "*.log" -exec rm {} +

# 例: コマンドにパイプやリダイレクトを使う場合はsh -cを用いる
find . -name "*.log" -exec sh -c 'cat {} | grep ERROR' \\;
```
# ハードリンク
実体ファイルへの別名。ファイルは同じファイルシステム内に存在する必要がある。
リンク元のファイルを削除してもリンクからアクセス可能。
# シンボリックリンク(symlink)
`ls` コマンドの出力の2列目が1のものはシンボリックリンクを示す。シンボリックリンクとはパスのショートカットのようなもの。下の例では `bin` は `/usr/bin` へのシンボリックリンク。両者は矢印で関連付けられる。
リンクに対するファイルを削除するとそのリンクは「壊れたリンク」になる。
```bash
┌──(kali㉿kali)-[/]
└─$ ls -l
total 1048648
lrwxrwxrwx   1 root root          7 Feb 25 10:35 bin -> usr/bin
drwxr-xr-x   3 root root       4096 Feb 25 12:42 boot
drwxr-xr-x  17 root root       3400 May 12 14:29 dev
drwxr-xr-x 182 root root      12288 May 12 14:14 etc
drwxr-xr-x   3 root root       4096 Feb 25 10:57 home
lrwxrwxrwx   1 root root         27 Feb 25 12:42 initrd.img -> boot/initrd.img-6.6.9-amd64
lrwxrwxrwx   1 root root         27 Feb 25 12:42 initrd.img.old -> boot/initrd.img-6.6.9-amd64
```
`pwd` コマンドに `-P`オプションをつけることで本当のパスを表示できる。
## ln
lnコマンドを利用してシンボリックリンクを作成することができる。リンクはカレントディレクトリに作成される。
```bash
ln -s FILE_PATH LINK_NAME
```
# more/less
ファイルの中身を1画面ごとに表示するコマンド。catのようにファイルの中身全てを一度に表示しないので便利。
moreコマンドは最後のページに到達したときに自動的に終了するが、lessコマンドはQキーを押すまで終了しない。
```bash
more FILE_PATH
less FILE_PATH

# または

cat FILE_PATH | more
cat FILE_PATH | less
```
主要なキーバインドは以下。

|共通キーバインド|説明|
|---|---|
|F or Space|一画面分下にスクロール|
|B|一画面分上にスクロール|
|Q|表示を終了|
|Enter|一行進む|

| lessのキーバインド | 説明                |
| ----------- | ----------------- |
| Shift + <   | ファイルの先頭に移動        |
| Shift + >   | ファイルの末尾に移動        |
| /           | 続けて入力したキーワードで前方検索 |
| ?           | 続けて入力したキーワードで後方検索 |
# グロブ
ワイルドカードなどのパターンをマッチする実際のファイルパスに置き換える処理。

| グロブ | 説明                    |
| --- | --------------------- |
| *   | 0文字以上の任意の文字列にマッチ      |
| ?   | 任意の一文字にマッチ            |
| []  | 括弧に含まれる文字のいずれか1文字にマッチ |
グロブ文字を展開させたくない場合はシングルクォートで囲む。
# ユーザ
## root
システム管理を担う最高権限を持つユーザ。UIDとGIDは原則0。
## システムユーザ
サーバプログラムの実行や管理のための特別なユーザ。webサーバ用のwww-dataユーザやapacheユーザ、DBサーバ用のpostgresユーザなど。他にもdaemonやnobodyなど。
## 一般ユーザ
上の二種類以外のユーザ。
## /etc/passwd
システム内のアカウントに関する情報を規定するファイル。
```bash
┌──(kali㉿kali)-[~]
└─$ cat /etc/passwd
root:x:0:0:root:/root:/usr/bin/zsh
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
account:/var/run/stunnel4:/usr/sbin/nologin
_rpc:x:118:65534::/run/rpcbind:/usr/sbin/nologin
geoclue:x:119:122::/var/lib/geoclue:/usr/sbin/nologin
_gvm:x:133:136::/var/lib/openvas:/usr/sbin/nologin
kali:x:1000:1000:,,,:/home/kali:/bin/zsh
```

| No  | フィールド       | 概要                                                                           |
| --- | ----------- | ---------------------------------------------------------------------------- |
| 1   | ユーザ名        |                                                                              |
| 2   | 暗号化されたパスワード | 値が `x` の場合はシャドウ化されている。 `/etc/shadow` ファイルで暗号化されたパスワードを確認できる。                 |
| 3   | UID         | ユーザID                                                                        |
| 4   | GID         | ユーザのメイングループの番号                                                               |
| 5   | GECOS       | ユーザに関する補足情報                                                                  |
| 6   | ホームディレクトリ   | ユーザのホームディレクトリの絶対パス                                                           |
| 7   | ログインシェル     | システムにログインした時に自動で起動されるプログラムの絶対パス。ユーザアカウントであれば通常は `/bin/bash` などの対話型シェルが設定される。 |
## /etc/shadow
`/etc/passwd` の暗号化されたパスワードをまとめたファイル。
```bash
┌──(kali㉿kali)-[~]
└─$ sudo cat /etc/shadow
[sudo] password for kali:
root:*:19778:0:99999:7:::
daemon:*:19778:0:99999:7:::
bin:*:19778:0:99999:7:::
sys:*:19778:0:99999:7:::
_apt:*:19778:0:99999:7:::
nobody:*:19778:0:99999:7:::
statd:!:19778::::::
redis:!:19778::::::
postgres:!:19778::::::
mosquitto:!:19778::::::
inetsim:!:19778::::::
_gvm:!:19778::::::
kali:$y$j9T$hW9K52EOJBFsViQ7HRz370$//6l5BWkvHl3PTkK6qgZhGFTLOFKR/zVCEwjlZIwAq0:19778:0:99999:7:::
```

| No  | フィールド       | 概要                                                     |
| --- | ----------- | ------------------------------------------------------ |
| 1   | ユーザ名        |                                                        |
| 2   | パスワードハッシュ   | 後述                                                     |
| 3   | 最終パスワード変更日  | タイムスタンプ表記。0の場合は次回アクセス時にパスワードを変更する必要がある。                |
| 4   | パスワード最小利用期間 | パスワード変更後、ユーザがパスワードを再度変更できるようになるまでに経過する必要がある最小日数。       |
| 5   | パスワード最大利用期間 | パスワードの変更が必要になるまでの最大日数。                                 |
| 6   | パスワード警告期間   | パスワードの有効期限が切れる前にパスワードを変更する必要がある事をユーザに警告する日数。           |
| 7   | インアクティブ機関   | パスワードの有効期限が切れてからユーザがパスワードを更新できる日数。この期間の経過後アカウントは無効になる。 |
| 8   | アカウント有効期限   | アカウント失効までの日数。空の場合は無制限のアカウントを意味する。                      |
| 9   | 予約フィールド     | 将来の利用のために予約されているフィールド。現在は使用されていない。                     |

## パスワードハッシュ
第二フィールド

|値|説明|
|---|---|
|`*`|パスワードが未設定でログイン不可。システムユーザの場合はログインすることはないのでパスワードが無効になっている。|
|空欄|パスワード不要でログイン可能|
|`!` , `!!`|パスワードが無効(ログイン不可)|
第二フィールドの先頭の `$` で囲まれた文字列。

|文字列|説明|
|---|---|
|指定なし|bigcrypt|
|`$1$`|MD5|
|`$2$` , `$2a$` , `$2b$` , `$2x$`|bcrypt|
|`$5$`|SHA256|
|`$6$`|SHA512|
|`$y$`|yescript|
# グループ
複数のユーザを意味のあるまとまりに所属させる概念。ユーザは基本となる一つのグループ(プライマリーグループ)に必ず所属する。これ以外に所属するグループはサブグループという。
`groups` コマンドでユーザが所属するグループを表示できる。

```bash
# 引数を指定しなければ自分自身のグループを表示する
groups USER_NAME
```
## /etc/group
グループIDを規定するファイル。
```bash
┌──(kali㉿kali)-[/]
└─$ cat /etc/group
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
adm:x:4:kali
tty:x:5:
disk:x:6:
lp:x:7:
mail:x:8:
news:x:9:
uucp:x:10:
man:x:12:
proxy:x:13:
kmem:x:15:
dialout:x:20:kali
```

|No|フィールド|概要|
|---|---|---|
|1|グループ名||
|2|暗号化されたグループパスワード|*または!の場合はパスワードが無効|
|xの場合はシャドウ化されている|||
|3|GID||
|4|所属ユーザ|当該グループに所属するユーザ一覧|
|そのグループをメイングループにしているユーザは含める必要がない|||
## /etc/gshadow
シャドウ化されたグループパスワード一覧。
# chown/chgrp
ファイルの所有者/所有グループを変更するコマンド。
```bash
sudo chown USER FILE_PATH
sudo chgrp GROUP FILE_PATH
```
# ls
ディレクトリ内のファイルやディレクトリの一覧を表示するコマンド。
## オプション

|**オプション**|**説明**|
|---|---|
|**`-a`**|隠しファイルやディレクトリも含めて全てのファイルを表示します。|
|**`-l`**|詳細情報を表示します（ロングフォーマット）。ファイルのパーミッション、所有者、サイズ、最終更新日時などが表示されます。|
|**`-h`**|ファイルサイズを読みやすい形式（例: KB, MB）で表示します。このオプションは **`-l`** と共に使われることが多いです。|
|**`-r`**|ファイルを逆順に表示します。|
|**`-t`**|ファイルを最終変更時間でソートして表示します。|
|**`-S`**|ファイルサイズでソートして表示します。|
|**`--color`**|ファイルのタイプに応じて色を付けて表示します（通常はデフォルトで有効）。|
`-l` オプションを用いた場合の各列の意味は以下。

|**列番号**|**内容**|**説明**|
|---|---|---|
|1|権限 (Permissions)|ファイルやディレクトリのアクセス権限。例: **`drwxr-xr-x`**（ディレクトリで所有者に全権限、他に読み実行権限）|
|2|リンク数 (Links)|ファイルへのハードリンク数、またはディレクトリ内のサブディレクトリ数（自身と親を含む）|
|3|所有者 (Owner)|ファイルまたはディレクトリの所有者名|
|4|グループ (Group)|ファイルまたはディレクトリが属するグループ名|
|5|サイズ (Size)|ファイルのサイズ（バイト単位）。ディレクトリの場合はディレクトリ自体のサイズ|
|6|最終変更日時 (Date)|ファイルまたはディレクトリが最後に変更された日時|
|7|名前 (Name)|ファイルまたはディレクトリの名前|

# nano
CUIのテキストエディタ。
```bash
# nanoを開く
nano

# 任意のファイルを開く
nano FILE_PATH
```
主要なキーバインドは以下。 `^` はctrlキー、 `M` はaltキーを示す。

| キーバインド | 説明                        |
| ------ | ------------------------- |
| `^O`   | 任意のファイルを読み込み/ファイルの変更を読み込み |
| `^X`   | 終了                        |
| `^S`   | 保存                        |

## オプション

| オプション     | 説明                                     |
| --------- | -------------------------------------- |
| `-B`      | バックアップファイルを作成（編集前のファイルを`ファイル名~`として保存）。 |
| `-E`      | 行末の空白を自動的に削除。                          |
| `-i`      | 自動インデントを有効にする。                         |
| `-k`      | カーソル位置をスクリーンの中央に保つ。                    |
| `-m`      | マウス操作を有効にする。                           |
| `-r [数値]` | 行の折り返し幅を設定（数値で指定）。                     |
| `-s`      | スムーズスクロールを有効にする（行単位ではなくピクセル単位でスクロール）。  |
| `-T [数値]` | タブ幅を設定（デフォルトは8）。                       |
| `-v`      | 読み取り専用モードで開く。                          |
| `-w`      | テキストの折り返しを無効化（長い行をそのまま表示）。             |
| `-z`      | Suspend（中断）を許可する（`Ctrl + Z`で一時停止可能）。   |
| `-l`      | 行番号を表示                                 |

nanoに関する設定は `~/.nanorc` に記述する。
# VIM
基本はノーマルモード。文字を入力する際のみ挿入モード。
escキーでノーマルモードに戻る
## 保存

| コマンド         | 実行内容       |
| ------------ | ---------- |
| :q           | 編集終了       |
| :q!          | 保存しないで編集終了 |
| :wq          | 保存して終了     |
| :w FILE_NAME | 名前をつけて保存   |
| :w           | 上書き保存      |
| ZZ           | 保存して終了     |

## 移動

|コマンド|実行内容|
|---|---|
|h|一つ左に移動|
|j|一つ下に移動|
|k|一つ上に移動|
|l|一つ右に移動|
|$|行末に移動|
|^|左端の文字に移動|
|0|行の左端に移動|
|[行数]G or [行数]gg|行数を指定して移動|
|gg|先頭行に移動|
|G|末尾の行に移動|
|gd|定義元にジャンプ|
|[行数]j|相対行数下に移動|
|ctrl + o|前のカーソル位置に移動|
|ctrl + i|次のカーソル位置に移動|
|zz|カーソルが画面中央になるように画面を移動|
|zEnter or zt|カーソルが画面上部になるように移動|
|zb or z-|カーソルが画面下部になるように移動|
|||
|ctrl + u|半画面上にスクロール|
|ctrl + d|半画面下にスクロール|
|w|次の単語の初めまで移動|
|e|今の単語の末尾まで移動|
|b|前の単語の初めまで移動|
|W|スペース区切りの単語の初めまで移動|
|E|スペース区切りの単語の末尾まで移動|
|f[任意の文字]|右側の任意の文字までカーソルを移動(記号や大文字や数字を目印に移動するのがおすすめ)|
|F[任意の文字]|左側の任意の文字までカーソルを移動|
|t[任意の文字]|右側の任意の文字の一つ手前までカーソルを移動|
|T[任意の文字]|右側の任意の文字の一つ手前までカーソルを移動|
|%|対応する括弧に移動|
|:[行番号]d + enter|行番号を指定して削除(c不可)|

## 挿入

|コマンド|実行内容|
|---|---|
|i|カーソルの左で挿入モード|
|a|カーソルの右で挿入モード|
|o|行を下に追加して挿入モード|
|O|行を上に追加して挿入モード|
|I|行の左端で挿入モード|
|A|行の右端で挿入モード|

## マクロ

|コマンド|実行内容|
|---|---|
|q[任意の文字]|[任意の文字]という名前のマクロの記録を開始|
|q|マクロの記録を終了|
|:reg|記録されているマクロの一覧|
|:reg [任意の文字]|[任意の文字]という名前のマクロの内容を確認|
|@[任意の文字]|[任意の文字]という名前のマクロを実行|
|@@|直前に呼び出したマクロを実行|

## 検索＆置換

|コマンド|実行内容|
|---|---|
|/[検索文字列]|カーソル位置以降で文字列を検索|
|?[検索文字列]|カーソル位置以前で文字列を検索|
|:%s/置換前/置換後 + enter|ファイル全体を対象に各行の初めにマッチする文字列を置換|
|:n,ms/置換前/置換後 + enter|n行目からm行目までを対象に各行の初めにマッチする文字列を置換|
|:%s/置換前/置換後/g + enter|ファイル全体を対象に文字列を置換|
|:n,ms/置換前/置換後/g + enter|n行目からm行目までを対象に文字列を置換|

`/[置換対象文字列]` + enterで置換対象の文字列を検索した後に `:%s//[置換後文字列]/g`によって置換する。
## 編集

|コマンド|実行内容|
|---|---|
|ctrl + a|カーソルの数字を増やす|
|r[任意の文字]|カーソルの文字を任意の文字に変更|
|p|カーソルの後ろに追加|
|P|カーソルの前に追加|
|diw|単語削除|
|shift + v|ビジュアルモードに入り行を選択|
|選択した行を切り取り|d|
|[数字]dd|今いる行から数字の行数を削除|
|x|一文字削除|
|c|削除＆挿入モード|
|di(|()の中を削除|
|di{|{}の中を削除|
|di[]|[]の中を削除|
|di’|‘の中を削除|
|di”|“の中を削除|
|di<|<>の中を削除|
|dit|HTMLタグの中を削除|
|da(|()と()自身を削除|
|dw|今いるカーソル位置からwコマンドの移動先までを削除|
|.|前回のコマンドの内容を繰り返す|
|u|直前の操作を取り消し|
|d$ or D|カーソルから行末まで削除|
|^d$|行削除(改行は含まれない)|
|yy or Y|一行コピー|
|yw|現在のカーソル位置からwコマンドの移動先までをコピー|
|yiw|単語をコピー|
|vi(|()の中身を選択|
|“[文字]di(|[文字]というレジスタに()の中身を入れる|
|“[文字]p|[文字]というレジスタの中身をペースト|
|ddp|行の前後入れ替え|
|df[文字]|[文字]までを削除|
|df)|)まで削除|
|dt)|)の手前まで削除|
|yt[文字]|[文字]の手前までコピー|
|cc|カーソルがある行の内容を削除して同じ行で挿入モード|

## ビジュアルモード

| v         | 始点から終点までを選択            |
| --------- | ---------------------- |
| ctrl + v  | 始点と終点を角とする長方形を選択(矩形選択) |
| shift + v | 行選択。上下の移動のみ有効          |

矩形選択は揃ったデータをまとめて編集するときに用いることが多い。(varをconstに変更など)
## その他

| コマンド                       | 実行内容                      |
| -------------------------- | ------------------------- |
| :colorscheme [colorscheme] | カラースキームを指定                |
| :e [filename]              | カレントディレクトリにあるファイル名を指定して開く |
| :e %:h<tab>                | 現在開いているファイルが存在するディレクトリを表示 |
| :new                       | 横分割で新規ファイルを開く(バッファ)       |
| :vnew                      | 縦分割で新規ファイルを開く(バッファ)       |
| :tabnew                    | 新しいタブで新規ファイルを開く(バッファ)     |
| :save                      | 新規ファイルをカレントディレクトリに保存      |
| :sp or <C-w>s              | ウィンドウを横に分割                |
| :vs or <C-w>v              | ウィンドウを縦に分割                |
| <C-w>w                     | 次のウィンドウに移動                |
| <C-w>hjkl                  | 上下左右のウィンドウに移動             |
| :tabn or {count}gt         | {count}で指定した番号のタブへ移動      |
| :tabn or gt                | 次のタブへ移動                   |
| :tabp or gT                | 前のタブへ移動                   |
| :buffers                   | バッファリストのファイル名をリスト表示       |
| :b                         | バッファリストの指定したバッファを開く       |
| :changes                   | 変更リスト(編集した箇所)を表示          |
| g;                         | 前の変更箇所へ移動                 |
| g,                         | 次の変更箇所に移動                 |
| :![コマンド]                   | OSコマンドを実行                 |

# ジョブ(プロセス)のバックグラウンド起動
ジョブとはシェルから見た処理の単位。フォアグラウンドジョブとバックグラウンドジョブの2つがあり、前者はキーボードからの入力を受け取れる状態のジョブ、後者は陰で動いているジョブ。このほかにも停止状態(ctrl + Zで移行)がある。
jobsコマンドを用いて実行中または停止中のプロセスを表示できる。

```bash
# lオプションでPIDを表示
jobs -l

# 任意のコマンドの最後にアンパサンド(&)をつけるとバックグラウンド実行できる。
wireshark &

# bgコマンドを用いてもバックグラウンドにできる
bg
```
fgコマンドでフォアグラウンドにすることができる。
```bash
# 引数を指定しないとカレントジョブが対象になる
fg %JOB_NUMBER
```
ジョブ番号はjobsコマンドの出力の左端の番号。
# kill
プロセスやジョブを中断できる。
```bash
kill -SIGNAL_NAME_OR_NUM PROCESS_ID
```
シグナルを省略するとTEMシグナルを送信する。
シグナル一覧は以下。

|番号|シグナル名|動作|同等の操作|
|---|---|---|---|
|1|SIGHUP|ハングアップ。端末回線切断。|delete|
|2|SIGINT|プロセス終了|ctrl + c|
|3|SIGQUIT|コアダンプ(プロセスのメモリを記録)して終了|ctrl + /|
|6|SIGABRT|プロセスの異常終了。コアダンプが生成される。||
|9|SIGKILL|プロセスの強制終了||
|11|SIGSEGV|セグメンテーション違反を起こしてプロセスを異常終了。コアダンプが生成される。||
|15|SiGTERM|プロセス終了||
|17|SIGCHLD|プロセス終了を親プロセスに通知||
|18|SIGCONT|プロセス再開。サスペンドから復帰|bgコマンド|
|19|SIGSTOP|プロセスの強制一時停止||
|20|SIGTSTP|プロセスの一時停止。サスペンド|ctrl + z|

# 変数
文字列を値として一時的に記憶する変数。ターミナルを起動し直すと親子関係のない新しいシェルになるためシェル変数も環境変数も引き継がれない。
## シェル変数
その変数を定義したシェルまたはプロセスのみに有効。
```bash
# 定義
HOGE=hogehoge

# 参照
echo $HOGE
>>>hogehoge

# 空白を含む文字列を代入するときはダブルクォートで囲む
HOGE2="Hello world"

# 明示的に変数を中括弧で括る
echo ${HOGE}aaaa
```
## 環境変数
その変数を定義したシェルと、そのシェルで実行するプロセスすべてに有効。
```bash
# 既存のシェル変数を環境変数にする
HOGE=hogehoge
export HOGE

# 環境変数を新しく作る
export VAR=value
```
# ドルパーレン

ドルパーレンで括った中のコマンドが先に実行される。

```bash
# まずはwhoamiコマンドが実行され、その実行結果がechoコマンドで出力される
echo $(whoami)
```
# Linux Permission
Linuxにおけるファイルやディレクトリに対する権限にはいくつかの表記方法がある。
## 基本的な表記
例: `-rwxrw-r--`
先頭の1文字と、その後ろを3文字ずつに分割した4つの部分から構成される。各部分の役割は
1. ファイルの種類(-: 通常ファイル, d: ディレクトリ, l: シンボリックリンク)
2. ユーザに対するパーミッション
3. グループに対するパーミッション
4. その他のユーザに対するパーミッション
## シンボリックモード
文字や記号を用いてパーミッションの変更ができる。
```bash
chmod [USER][ACTION][PERMISSION] FILE_NAME

# 所有者の書き込み権限を追加
chmod u+w filename

# 所有者の読み取り権限を削除
chmod u-r filename

# 所有者のパーミッションを読み書きのみに設定
chmod u=rw filename

# 所有者に実行権限を付与しグループから実行権限を削除
chmod u=rw,g=r,o= filename
```
### USER
u: 所有者
g: グループ
o: その他
a: すべてのユーザ
### ACTION
+: 許可を与える
-: 許可を削除する
=: 許可を設定する
`=`を用いた場合は、その後ろに指定した権限以外の権限は削除される。

### PERMISSION
r: 読み取り権(read)
w: 書き込み権(write)
x: 実行権(execute)
s: SUIDまたはSGIDが設定されている
t: スティッキービットが設定されている
## オクタルモード
例: `764`
パーミッションを8進数の数値で表す。r=4, w=2, x=1, 権限なし=0として表現される。
例えば `-rwxrw-r--` は、先頭の一文字を除いた3つの部分について前から考えると
rwx = 4+2+1 = 7
rw- = 4+2+0 = 6
r— = 4+0+0 = 4
となるから、 `764` と表される。
ただし、SUIDは4000、SGIDは2000、スティッキービットは1000で表される。
## SUID
SUIDはファイルの所有者の権限を引き継いで実行するというパーミッション。実行可能ファイルにSUIDが設定されていれば実行ユーザの権限ではなくファイルの所有者の権限で実行される。
SUIDが設定されているとオーナーパーミッションのxの位置がsになる。
## SGID
実行時にファイルのグループの権限を引き継ぐパーミッション。
## sticky
ディレクトリ内にあるファイルやディレクトリに対して削除を制限するパーミッション。以下の条件を満たすユーザだけがファイルを削除したりリネームできる。
- ディレクトリの書き込み権限を持ちかつそのファイルの所有者
- ディレクトリの所有者
- スーパーユーザ
stickyが設定されているとアザーパーミッションのxの位置がtになる。
# 拡張属性
通常のパーミッションでは設定できない特別な属性をファイルやディレクトリに付与する仕組み。

|属性|説明|
|---|---|
|**`i`**|immutable（変更不可）：ファイルを変更・削除できなくなります。|
|**`a`**|append-only（追記専用）：ファイルへのデータの追記のみ可能になります。|
|**`c`**|compress（圧縮）：ファイルを自動的に圧縮するようファイルシステムに指示します。|
|**`d`**|no dump：バックアップ時に `dump` コマンドがファイルを無視します。|
|**`e`**|extent-based mapping：拡張マッピングを使用しているファイルを示します。|
|**`s`**|secure deletion：削除時にファイルデータをゼロで上書きします。|
|**`t`**|no tail-merging：ファイルシステムの「テールパッキング」を無効にします。|

## lsattr
拡張属性を確認するコマンド。
```bash
lsattr OPTIONS FILE_PATH

# 出力例
----i--------- example.txt
```
## chattr
拡張属性を追加・削除するコマンド。
```bash
# immutable属性を追加
chattr +i FILE_PATH

# immutable属性を削除
chattr -i FILE_PATH

# immutableとappend-only属性を追加
chattr +ia FILE_PATH
```
設定する属性の前に `-` をつけるとその属性を削除し、 `+` をつけるとその属性を追加する。
# chown

ファイルやディレクトリの所有者やグループを変更するコマンド。

```bash
chown OPTIONS USER:GROUP FILE
```

例

```bash
# file.txtの所有者をuser1に変更するが、グループは変更しない
chown user1 file.txt

# file.txtの所有者をuser1、グループをgroup1二変更する
chown user1:group1 file.txt

# file.txtのグループをgroup1にするが、所有者は変更しない
chown :group1 file.txt

# 指定したディレクトリ内のすべてのファイルとディレクトリの所有者とグループを変更する
chown -R user1:group1 DIRECTORY
```

# su

ユーザを切り替えるためのコマンド。

```bash
su USER_NAME

# ユーザ名を省略するとrootに切り替わる
su

# ユーザ切替後のカレントディレクトリが切替先ユーザのホームディレクトリになる
su - USER_NAME

# rootのパスワードがわからない場合はsudoを用いてbashを起動するとよい
sudo bash
```

# useradd

新しいユーザアカウントを作成するコマンド。

```bash
useradd OPTIONS USER_NAME
```

オプション

|オプション|説明|
|---|---|
|-m|ホームディレクトリを自動作成|
|-s|ユーザのデフォルトシェルを引数に取る(bash, shなど)|
|-u|UIDを引数に取る|
|-G|補助グループ名を引数に取る|
|-c|ユーザの説明を引数に取る|

## passwd

ユーザ作成時にはパスワードが設定されていないのでpasswdコマンドで設定する。

```bash
sudo passwd USER_NAME
```

## userdel

ユーザアカウントを削除するコマンド。

```bash
sudo userdel USER_NAME

# ホームディレクトリも削除
sudo userdel -r USER_NAME
```

# usermod

ユーザの情報を変更するコマンド。

```bash
usermod OPTIONS USER_NAME
```

|オプション|説明|
|---|---|
|`-l`|ユーザー名を変更|
|`-d`|ホームディレクトリを変更|
|`-m`|ホームディレクトリの内容を移動|
|`-s`|ログインシェルを変更|
|`-u`|ユーザーID（UID）を変更|
|`-g`|プライマリグループを変更|
|`-G`|補助グループを変更|
|`-a`|補助グループを追加|
|`-c`|ユーザーのコメントを変更|
|`-e`|アカウントの有効期限を設定|
|`-f`|パスワードの有効期限を指定（0で無期限）|
|`-L`|アカウントをロック|
|`-U`|アカウントをアンロック|
|`-p`|暗号化されたパスワードを指定|
|`-k`|スケルトンディレクトリを指定|
|`-o`|UIDの重複を許可|

# groupmod

ユーザの情報を変更するコマンド。

```bash
groupmod OPTIONS GROUP_NAME
```

|オプション|説明|
|---|---|
|`-n`|グループ名を変更|
|`-g`|グループID（GID）を変更|

# sudo

特定のコマンドをrootユーザ権限で実行するコマンド。

```bash
sudo OPTIONS COMMAND
```

オプションは以下。

|**オプション**|**説明**|
|---|---|
|**`-u ユーザー名`**|指定したユーザー名の権限でコマンドを実行します。デフォルトは root ユーザーです。|
|**`-i`**|指定ユーザーのログインシェルを起動し、その環境でコマンドを実行します。|
|**`-s`**|指定ユーザーのシェルを起動しますが、ログインプロセスは行われません。|
|**`-l`**|現在のユーザーが実行可能な **`sudo`** コマンドのリストを表示します。|
|**`-v`**|**`sudo`** のタイムアウト時間を延長します。パスワードの再入力を求めることで、次の **`sudo`** コマンド実行時にパスワードの入力を省略できます。|
|**`-k`**|ユーザーの **`sudo`** セッションを終了させ、次回 **`sudo`** を実行する際にパスワードを要求します。|
|**`-K`**|ユーザーの **`sudo`** セッションを完全に終了させ、キャッシュもクリアします。|
|**`-E`**|環境変数を引き継いでコマンドを実行します。|
|**`--`**|オプションの終了を示し、それ以降の入力をコマンドの引数として扱います。|
# /etc/sudoers

sudoコマンドの設定ファイル。基本的な書式は以下。ユーザによって中身は異なる。

```bash
USER_NAME     HOST=(USER:GROUP) COMMAND
%GROUP_NAME   HOST=(USER:GROUP) COMMAND

# aliceユーザがsudoコマンドを使ってパスワードを入力すればpoweroffコマンドを実行できる
alice         ALL=PASSWD: /usr/sbin/poweroff

# bobユーザがパスワードなしでsudoコマンドを実行できる
bob ALL=(ALL) NOPASSWD:ALL
```

## HOST

複数のサーバで同じ設定を使いまわすときに設定を反映させるサーバを指定する項目。

## PRIVILEGE

どのユーザに成り代わってコマンドを実行できるかを示す。 `root` であればroot権限、 `ALL` であればrootを含めたすべてのユーザに成り代われる。

`(USER_NAME:GROUP_NAME)` のような形式で記述することもできる。

## COMMAND

許可するコマンドをフルパスで指定する。ディレクトリを指定するとそのディレクトリ直下のすべてのコマンドが実行可能になるがサブディレクトリは許可されない。

sudoersファイルを編集するときは `visudo` を用いること。設定ミスがあっても保存する前に警告を出してくれる。

なおsudoersファイルの下の方には `@includedir /etc/sudoers.d` という記述がありこれによってsudoersの設定が上書きされるので新しい設定を追加したい場合はこの記述よりも下に書くこと。
# doas

linuxやunix系システムにおいて特権昇格を行うためのコマンド。簡易版のsudoみたいなもの。

コマンドに関する設定は `/etc/doas.conf` で行う。

```bash
# コマンドをroot権限で実行
doas COMMAND

# 現在のユーザで別のユーザに切り替えてコマンドを実行
doas -u USER_NAME COMMAND
```

設定ファイル

```bash
# 特定のユーザにすべてのコマンド実行を許可
permit USER_NAME

# パスワードを一度入力したら一定期間は再入力不要にする
permit persist USER_NAME

# パスワード無しでrootとしてコマンドを実行可能にする
permit nopass USER_NAME as root

# wheelグループのユーザに特権昇格を許可
permit :wheel
```

設定ファイルの文法が正しいかどうか以下のコマンドで確認できる。

```bash
doas -C /etc/doas.conf
```

# ACL

Access Control List.

ファイルやディレクトリに対して標準的なrwxパーミッションよりも細かい単位でのアクセス権限を設定する仕組み。特定のユーザやグループに対して柔軟なアクセス制御が可能になる。

## getfacl

ファイルやディレクトリのACLを確認する。

```bash
getfacl FILE

getfacl example.txt
>>>
# file: example.txt
# owner: user
# group: group
user::rw-
user:john:r--       # ユーザーjohnに読み取り権限
group::r--
mask::r--
other::---
```

## setfacl

ACLを設定または変更する。

```bash
setfacl -m u:USER_NAME:RIGHT: FILE_NAME

# johnユーザにrw権限を付与
setfacl -m u:john:rw example.txt

# developersグループにrx権限を付与
setfacl -m g:developers:rx example.txt

# ディレクトリに作成されるファイルに自動的にjohnがrwxできる権限を付与
setfacl -d -m u:john:rwx DIRECTORY_NAME
```

`u:` は特定のユーザに対して権限を設定する。

`g:` は特定のグループに対して権限を設定する。

## ACLの確認

`ls -l` コマンドで一覧表示したファイルのうち、ACLが設定されているファイルには `+` が表示される。

```bash
ls -l example.txt
>>>
-rw-r--r--+ 1 user group 12345 Dec 25 14:30 example.txt
```

# curl

データの送受信を行うコマンド。

```bash
# デフォルトはGET
curl URL
```

オプションは以下。

| オプション           | 説明                                 |
| --------------- | ---------------------------------- |
| -X              | 引数にHTTPメソッドを取る(デフォルトはGET)          |
| -O              | 標準出力せずにダウンロード                      |
| -o              | 引数に結果を出力するファイル名を取る                 |
| -#              | 転送情報をプログレスバーのような形式で表示              |
| -s              | 転送情報を非表示                           |
| -S              | エラー情報を表示                           |
| -I              | Headerのみ取得して出力                     |
| -i              | Response Header, Body両方を出力         |
| -v              | リクエスト時のHeaderを表示                   |
| -d              | 引数にPOSTで送信するデータを取る                 |
| —data-urlencode | 引数にPOSTで送信するデータをエンコードして取る          |
| -F              | 引数にPOSTでアップロードするファイルを取る            |
| -u              | 引数にアカウント名とパスワードを指定してリクエスト(BASIC認証) |
| -c              | レスポンスのcookieを引数に指定したファイルに保存        |
| -b              | 引数に指定したファイルまたは文字列をリクエストのcookieに含める |
| -L              | リダイレクト先までアクセスする                    |
| -k              | SSL証明書を無視                          |
| -H              | Request Headerを指定する                |
| -q              | `.curlrc` ファイル(curlの設定ファイル)の内容を無視  |
| -x              | プロキシサーバのURLを引数に取る                  |
| -K              | オプションを指定したファイルを引数に取る               |

ヘッダーにCookieをセットしてjsonデータのパラメータ付きのPOSTリクエストを送信

```bash
curl -X POST aaa.com -H "Content-Type: application/json" -d '{"key1": "value1", "key2": "value2"}'
```

POSTリクエストのパラメータ形式がJSONのときは `Content-Type` ヘッダで形式を指定する必要がある。

`-F` オプションを利用する場合は `file=FILE_PATH` の形式で引数を書く。ファイルパスを `@sample.txt` のようにすることで相対パスで指定できる。

`-F` と `-d` は併用できない。

`-U` を用いる場合の引数の形式は `username:password` のようにする。このオプションを用いなくても `http://user:pass@hostname` のようにURLを指定すればよい。

`--data-urlencode` オプションは引数にPOSTで送信するデータをエンコードして取るが、 `--get` オプションと併用すればデータ送信時でもGETメソッドが強制され、送信するデータ( `--data-urlencode` の引数)はURLのクエリ文字列の一部として組み込まれる。

`jq` コマンドと併用して帰ってきたJSONを構造化された形で見ることができる。

```bash
curl -X POST xxx.com | jq .
```

Burpなどのプロキシを経由させたい場合は `-x` オプションを用いる。

```bash
curl -x <http://127.0.0.1:8080> URL
```
# grep

ファイルの中の文字列が含まれている行を表示するコマンド。

```bash
grep OPTIONS STRING FILE_NAME
```

オプションは以下。

| オプション     | 説明                         |
| --------- | -------------------------- |
| -C        | 検索結果に一致した個所から前後に指定した行数表示する |
| -i        | 大文字と小文字を区別せず表示する           |
| -e        | 一致処理に指定した正規表現を使う           |
| -v        | 一致しないものを検索                 |
| -l        | 検索結果にファイル名のみ表示             |
| -r        | ディレクトリ内も検索対象とする            |
| -o        | マッチした部分のみを抽出               |
| -P        | Perl正規表現を用いる               |
| -n        | 行番号を表示                     |
| —exclude  | 検索対象から除外するファイルを引数に取る       |
| -[number] | 合致した行の前後[number]行も表示       |
| -a        | 入力をバイナリではなくテキストとして扱う       |
| -o        | 一致した行から空白部分を除いて表示          |

# Base64

バイナリデータを文字列に変換する方法の一種。文字列のエンコード方式。エンコードするコマンド。

エンコードの仕様上、文字数は4の倍数となる。元の文字列の都合上4の倍数の文字数に変換できない場合は `=` を1つまたは2つ付けて調整する。

```bash
# エンコード
base64 STRING

# デコード
base64 -d STRING

# 出力を改行しない
base64 -w0 STRING
```

通常base64コマンドの出力は76文字ごとに改行が挿入される。改行を挿入させたくない場合は `-w0` オプションを付けると良い。 `w` の後ろの数字で行の最大文字数を指定するため `0` にすることにより改行を一切挿入しない。

# Base58

Base64で扱う文字から数字のゼロ、大文字のオー、小文字のエル、大文字のアイの4文字と、 `+` と `/` の2文字を除いた58文字を用いたエンコード方式。以下のような特徴がある。

- URLで特別な意味を持つ記号を使用しないのでURLとして使用できる
- ファイルシステムで特別の意味がある記号を使わないのでファイル名に使用できる

# 標準出入力

## リダイレクト

コマンドの出力先を変更する。

```bash
# 上書き
command > file

# 追記
command >> file
```

## ファイル記述子

terminalに表示される要素には標準出力と標準エラー出力の二種類がある。以下の様に出力先を明示することができる。

```bash
# 標準出力のファイル記述子は1だが通常は省略される
command 1> file

# 標準エラー出力は2
command 2> file

# 標準出力とエラー出力の両方をファイルに出力
command 1> file 2> file

# こちらでも同じ
command &> file
```

## 標準入力

標準入力を指定したファイルにリダイレクトするには `<` を用いる。

```bash
command < file
```

## catコマンドとの組み合わせ

引数なしでcatを実行するとterminal上の標準入力から読み込む(terminalに入力した内容がcatへの入力になる)。入力結果のリダイレクト先として `>` でtestファイルを指定することで、terminalに入力した内容をtestファイルに保存することができる。

```bash
cat > test
aaaa
bbb
# [ctrl + D]で編集終了
```

任意の文字列が入力された場合に編集終了することもできる。

```bash
cat << EOF> /tmp/pwn.conf
# 入力
EOF # 任意の文字列(EOF)を入力すると編集終了する
```

# パイプ

コマンドの実行結果を別のコマンドに渡して処理させる。 `|` で複数コマンドをつなぐ。

```bash
command1 | command2 | command3

# 例: /etc内のファイル一覧をファイルに保存して頭1行を表示する
ls /etc | tee files.txt | head -n 1
```

# mkdir

ディレクトリを作成するコマンド。

```bash
mkdir DIRECTORY_NAME
```

オプションは以下。

|オプション|説明|
|---|---|
|-p|パスで指定された親ディレクトリも作成(複数階層を作成)|
|-m|引数に権限を指定(chmodと同様の形式)|
# rbash

機能制限されたbash。

- 環境変数PATHが読み取り専用
- フルパスでコマンドを実行できない
- リダイレクトできない
- 機能制限モードを解除できない

などの特徴を持つ。使えるコマンドも制限されているので `/usr/bin` などを参照して使えるコマンドを調べる。
# nohup

ターミナルを閉じてもコマンドを継続実行したい場合に用いる。

```bash
nohup COMMAND &
```

# wc

テキストファイルの行数・単語数・文字数などをカウントするコマンド。

```bash
wc OPTIONS FILE_PATH
```

オプションは以下。

|オプション|説明|
|---|---|
|-l|行数のみを表示|
|-w|単語数のみを表示|
|-c|バイト数のみを表示|
|-m|文字数のみを表示|

# sort

テキストファイルの内容を行単位でソートするコマンド。デフォルトだとファイルの内容をアルファベット順にソートして出力する。

```bash
sort FILE_NAME
```

オプションは以下。

|オプション|説明|
|---|---|
|-n|行を数値として解釈してソート|
|-r|ソート結果を逆順にする|
|-u|重複する行を削除してソート|
|-k|引数にソートの基準とする列のインデックスを取る|
|-d|文字だけを考慮してソート|

# uniq

テキストファイルの中で連続して重複している行を削除またはカウントするために使われる。sortコマンドと併用することが多い。デフォルトでは連続して重複している行を削除した結果を出力する。

```bash
uniq FILE_NAME
```

オプションは以下。

|オプション|説明|
|---|---|
|-c|各行がファイル内で出現した回数をカウントして表示する|
|-u|重複していない行のみ表示する|
|-d|重複している行のみを表示する|
|-f|引数に無視する先頭の列数を指定する|
|-s|引数に行の先頭からの無視する文字数を指定する|

# iptables

ネットワークパケット処理をするツール。トラフィックを制御してパケットフィルタリング、ネットワークアドレス変換(NAT)、パケット転送・変更のルール定義に使用される。

## テーブル

各テーブルは異なる処理を行う。

| テーブル   | 説明                        |
| ------ | ------------------------- |
| filter | パケットフィルタリング用のデフォルトテーブル    |
| nat    | NATルールを処理                 |
| mangle | パケットの特定のオプションを変更するルールを設定  |
| raw    | コネクショントラッキングをバイパスするルールを設定 |

## ポリシー

どのルールにも一致しないパケットの扱いを決める。

|ポリシー|説明|
|---|---|
|`ACCEPT`|パケットを許可します。このパケットはフィルタリングを通過します。|
|`DROP`|パケットを破棄します。このパケットは無視され、応答は返されません。|
|`REJECT`|パケットを拒否しますが、送信元に対してエラー応答を返します。|

## チェーン

ルールのリストのこと。パケットはルールに基づいて処理される。

|チェーン|説明|
|---|---|
|`INPUT`|ローカルホストに向けられたパケットを処理します。|
|`FORWARD`|ローカルホストを通過し、他のホストに転送されるパケットを処理します。|
|`OUTPUT`|ローカルホストから出るパケットを処理します。|
|`PREROUTING`|ルーティング決定前に処理されるパケット（主にNAT目的で使用）。|
|`POSTROUTING`|ルーティング決定後に処理されるパケット（主にNAT目的で使用）。|

## コマンド例

```bash
# ルールをリスト表示
iptables -L

# 特定のテーブル(NAT)のルールをリスト表示
iptables -t nat -L

# 特定のチェーン(INPUT)のルールをリスト表示
iptables -L INPUT

# 特定のIPからの入力を拒否するルールを設定
iptables -A INPUT -s IP_ADDRESS -j DROP

# ルールを削除
iptables -D INPUT -s IP_ADDRESS -j DROP

# ルールを変更
iptables -R INPUT 1 -s IP_ADDRESS -j ACCEPT

# すべての入力をデフォルトで拒否するポリシーを設定
iptables -P INPUT DROP

# 400~65535番ポートに向けて送信されたパケットを1234番にリダイレクトする
# ルーティングされるとその後の処理で使用される宛先が確定してしまうのでPREROUTINGを指定する必要がある
# PREROUTINGを指定することでリダイレクトが行われていることがクライアントに認識されない
iptables -A PREROUTING -t nat -p tcp --dport 400:65535 -j REDIRECT --to-port 1234
```

オプションは以下。

|オプション|説明|
|---|---|
|`-A`|新しいルールをチェーンの末尾に追加します。|
|`-D`|指定されたルールをチェーンから削除します。|
|`-R`|指定された既存のルールを変更。チェーンまたはテーブルとルールのインデックスを引数にとる。|
|`-I`|新しいルールをチェーンの指定された位置に挿入します。|
|`-L`|ルールを一覧表示します。|
|`-F`|チェーン内のすべてのルールを削除します（フラッシュ）。|
|`-Z`|チェーン内のパケットとバイトのカウンタをゼロにリセットします。|
|`-N`|新しいチェーンを作成します。|
|`-X`|指定されたチェーンを削除します（使用中でない場合）。|
|`-P`|チェーンのデフォルトポリシーを設定します。|
|`-s`|送信元アドレスを指定します。|
|`-d`|宛先アドレスを指定します。|
|`-j`|パケットがルールに一致した場合のアクション（ジャンプ先）を指定します。|
|`-p`|プロトコルを指定します（例：tcp、udp、icmp）。|
|`-t`|操作するテーブルを指定します（例：filter、nat）。|
|`--sport`|送信元ポートを指定します。|
|`--dport`|宛先ポートを指定します。|
|`--to-port`|リダイレクトする場合の宛先ポートを指定|
|`-v`|ルールの詳細表示|
|`-n`|ホスト・ポート・ユーザ名を数値形式で表示して名前解決を避ける。コマンド実行の高速化につながる。|

`-j` オプションの引数となるアクションの一覧は以下。

| アクション        | 説明                                   |
| ------------ | ------------------------------------ |
| `ACCEPT`     | パケットを受け入れ、処理を続行します。                  |
| `DROP`       | パケットを破棄し、何の通知も行いません。                 |
| `REJECT`     | パケットを拒否し、送信元にエラーメッセージを返します。          |
| `LOG`        | パケットに関する情報をログに記録します。                 |
| `REDIRECT`   | パケットを同じマシン上の別のポートにリダイレクトします。         |
| `MASQUERADE` | パケットの送信元アドレスを変更し、NAT（IPマスカレード）を行います。 |
| `SNAT`       | ソースNATを適用し、送信元アドレスを変更します。            |
| `DNAT`       | デスティネーションNATを適用し、宛先アドレスを変更します。       |
| `RETURN`     | 現在のチェーンの処理を終了し、呼び出し元のチェーンに戻ります。      |
| `MARK`       | パケットにマークを付けます（通常、後続の処理で使用される）。       |
| `QUEUE`      | パケットをユーザースペースにキューイングします。             |

# zip

ファイルやディレクトリを圧縮するコマンド。

```bash
# 複数のファイルを一つのzipファイルに圧縮
# この場合ディレクトリは再帰的に圧縮される
zip aaa.zip file1 file2 file3

# ディレクトリを再帰的に圧縮する
zip -r aaa.zip dir1

# zipファイルにファイルを追加する
zip aaa.zip new_file
```

オプションは以下。

|**オプション**|**説明**|
|---|---|
|**`-r`**|ディレクトリを再帰的に圧縮します。ディレクトリ内の全ファイルとサブディレクトリが含まれます。|
|**`-q`**|静かなモードで実行し、プログレスインジケーターや警告、エラーメッセージを表示しません。|
|**`-e`**|アーカイブを作成する際に暗号化を有効にします。|
|**`-o`**|アーカイブ内のすべてのファイルのタイムスタンプを現在の日時に設定します。|
|**`-u`**|アーカイブを更新します。既にアーカイブに存在しているファイルが変更されていれば、それらを更新します。|
|**`-9`**|最高圧縮率を指示します。圧縮レベルは0（無圧縮）から9（最大圧縮）まで設定可能です。|

zipファイルの解凍は以下のコマンド。

```bash
unzip aaa.zip

# 解凍せずに中身のファイル名だけ確認したい場合は-lオプションを付ける
unzip -l aaa.zip
```

# mktemp

一時的なファイルやディレクトリを作成するために利用されるコマンド。ファイル名の衝突を避けるのに役立つ。

```bash
mktemp OPTIONS TEMPLATE
```

## オプション

|オプション|説明|
|---|---|
|-t|ファイル名に指定したテンプレートを使用|
|-d|ディレクトリを生成|
|-u|ファイルを生成せず、一時ファイル名のみを生成|

## テンプレート

生成される一時ファイルの名前の基本形式を指定するために使用される。 `XXXXXX` という6文字のランダムな部分が必要。この部分がランダムな文字列で置き換えらえる。

```bash
	# "temp."で始まる名前のファイルを生成
mktemp temp.XXXXXX
```

# motdファイル

Message of the Dayファイル。ユーザがシステムにログインした際に表示されるメッセージを格納している。通常 `/etc/motd` ディレクトリに存在する。

# tar

複数のファイルをアーカイブファイル( `.tar` )にまとめたり、アーカイブファイルを展開するコマンド。

```bash
# 複数のファイルをアーカイブにまとめる
tar -cf archive.tar file1 file2 file3

# ディレクトリをすべてアーカイブにする
tar -cf achive.tar dirname

# アーカイブを展開
tar -xf achive.tar
```

## オプション

| オプション | 説明            |
| ----- | ------------- |
| -c    | アーカイブを作成      |
| -r    | アーカイブを更新      |
| -t    | アーカイブの内容を表示   |
| -x    | アーカイブを展開      |
| -f    | アーカイブファイル名を指定 |
# make

ソフトウェアビルドの自動化コマンド。プログラムのコンパイルとリンクのプロセスを管理する。 `Makefile` という特別なフォーマットのファイルを使用してソースコードのコンパイルやプログラム構築の手順を指示する。

## 基本的な概念

- **Makefile**: ビルドプロセスを指定するスクリプト。ターゲットと依存関係、それらを生成するための命令が含まれる。
- **ターゲット**: 生成したいファイルや実行するアクション。通常、実行ファイル、オブジェクトファイル、またはその他の出力ファイル
- **依存関係**: ターゲットを生成する前に更新またはチェックが必要なファイル
- **レシピ**: ターゲットを生成するために実行するコマンドのセット

## Makefileの例

```makefile
# ターゲット: 依存関係
program: main.o utils.o
	# レシピ:
	gcc -o program main.o utils.o

# 依存関係の具体的なコンパイル方法
main.o: main.c
	gcc -c main.c

utils.o: utils.c
	gcc -c utils.c

# 'make clean'を実行するとこのレシピが実行される
clean:
	rm -f *.o program
```

## Make コマンドの実行

- `make`: Makefileのデフォルトターゲットをビルド
- `make [target]`: 指定したターゲットをビルド
- `make clean`: 上の例では生成されたオブジェクトファイルと実行ファイルを削除

# rm

ファイルやディレクトリを削除するコマンド。このコマンドで削除されたファイルはゴミ箱には移動されず、復元は困難になる。

```bash
# ファイル削除
rm FILE_NAME

# 複数ファイル削除
rm FILE1 FILE2
```

## オプション

|オプション|説明|
|---|---|
|-i|対話モード。削除前に確認が求められる。|
|-f|存在しないファイルに対するエラーメッセージを表示しない。|
|-e|再帰モード。ディレクトリとその内容を削除。|

# ss

ソケット統計情報を表示するためのツール。 `netstat` コマンドの代替。

```bash
ss
```

オプションは以下。

|オプション|説明|
|---|---|
|`-l`|リスニングソケットを表示|
|`-t`|TCP ソケットを表示|
|`-u`|UDP ソケットを表示|
|`-p`|ソケットに関連するプロセス情報を表示|
|`-n`|アドレスとポート番号を名前解決せずに表示|
|`-6`|IPv6 ソケットを表示|
|`-w`|RAW ソケットを表示|
|`-i`|ソケットの詳細な情報を表示|
|`-a`|すべてのソケットを表示 (リスニングおよび非リスニング)|
|`-m`|メモリの使用状況を表示|
|`-s`|ソケット統計情報を表示|
|`-r`|ソケットのルート情報を表示|
|`-4`|IPv4 ソケットを表示|
|`-o`|ソケットのタイマー情報を表示|
|`-k`|ソケットのカーネル内部情報を表示|

# openssl

OpenSSLというライブラリに含まれるコマンドラインツール。暗号化・復号化・証明書管理・鍵生成・ハッシュ計算などの幅広い暗号化関連の操作が可能。

## passwd

パスワードを暗号化したハッシュ形式で生成する。

```bash
openssl passwd [OPTIONS]
```

|オプション|説明|
|---|---|
|-1|MD5ベースのハッシュ|
|-apr1|Apache専用のMD5ハッシュ|
|-5|SHA-256ベースのハッシュ|
|-6|SHA-512ベースのハッシュ|
|-salt|引数にソルトを指定|

# ps

プロセスの状態を確認するコマンド。

|オプション|説明|
|---|---|
|a|すべてのユーザのプロセスを表示|
|u|ユーザ志向のフォーマットで表示|
|x|デーモンなどの端末に関連付けられていないプロセスも表示|
|w|コマンドラインの表示幅を無制限にしてすべての引数を省略せずに表示。w1文字だと80字、wwだとより多くの文字が表示される|

## 出力例

```bash
ps aux
>>>
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.1  22520  3208 ?        Ss   10:00   0:01 /sbin/init
user     12345  0.2  0.5 123456  6789 pts/0    R+   10:30   0:00 bash
user     54321  1.5  2.0 345678 90123 ?        Sl   09:45   1:23 /usr/bin/python3 script.py
```

## 出力項目

|項目|説明|
|---|---|
|USER|プロセスを実行しているユーザー名|
|PID|プロセスID|
|%CPU|CPU使用率（プロセスが使用しているCPU時間の割合）|
|%MEM|メモリ使用率（プロセスが使用しているメモリの割合）|
|VSZ|仮想メモリサイズ（Virtual Memory Size）|
|RSS|実際に使用しているメモリ量（Resident Set Size）|
|TTY|プロセスが関連付けられている端末。`?` は端末なしを示す|
|STAT|プロセスの状態|
|START|プロセスが開始された時刻|
|TIME|プロセスが使用したCPU時間の累計|
|COMMAND|実行しているコマンド名と引数|

## STATの主な値

|STAT|説明|
|---|---|
|R|実行中（Running）|
|S|スリープ状態（Sleep）|
|D|割り込み不可のスリープ状態（Disk Sleep）|
|Z|ゾンビプロセス（Zombie）|
|T|停止中（Stopped）|
|I|アイドル状態（Idle）|
|X|終了中（Dead）|
|<|高い優先度で実行中|
|N|低い優先度で実行中|
|L|メモリロック中（Pages Locked）|
|s|セッションリーダー|
|+|フォアグラウンドプロセスグループ|

# netstat

ネットワークの接続状況や統計情報を確認するコマンド。ユーザシェル獲得後の内部ポートの確認などに利用可能。

```bash
netstat OPTIONS
```

| オプション | 説明                      |
| ----- | ----------------------- |
| `-a`  | すべてのソケット（リスニング中も含む）を表示  |
| `-t`  | TCP接続のみ表示               |
| `-u`  | UDP接続のみ表示               |
| `-n`  | アドレスを数値表記で表示（DNS解決をしない） |
| `-l`  | リスニング中のソケットのみ表示         |
| `-p`  | プロセスID（PID）とプログラム名を表示   |
| `-r`  | ルーティングテーブルを表示           |
| `-s`  | 各プロトコルごとの統計情報を表示        |


# 7z

高圧縮率のアーカイブを行うコマンド。 `.7z` 形式の圧縮ファイルを作成・解凍するために使われる。軽量版の `7za` コマンドも存在する。

```bash
7z COMMAND ARCHIVE_NAME FILE_OR_DIR OPTIONS
```

|COMMAND|実行する操作(圧縮・解凍・リスト表示など)|
|---|---|
|ARCHIVE_FILE|対象のアーカイブファイル名|
|FILE_OR_DIR|圧縮または解凍するファイルやディレクトリ|
|OPTIONS|オプションで圧縮率やパスワード保護などを設定|

## コマンド

|コマンド|説明|
|---|---|
|`a`|圧縮（アーカイブを作成）|
|`x`|解凍（ディレクトリ構造を保持）|
|`e`|解凍（すべて同じディレクトリに展開）|
|`d`|アーカイブからファイルを削除|
|`l`|アーカイブの内容をリスト表示|
|`t`|アーカイブの整合性をテスト|
|`u`|アーカイブの更新（差分追加）|

## 使用例

```bash
# 2つのファイルをarchive.7zに圧縮
7z a archive.7z file1.txt file2.txt

# ディレクトリごと圧縮
7z a archive.7z /path/to/directory/

# アーカイブをカレントディレクトリに解凍
7z x archive.7z

# 解凍してすべて同じディレクトリに展開
7z e archive.7z
```

## オプション

|オプション|説明|
|---|---|
|`-tzip`|ZIP形式で圧縮|
|`-tbzip2`|BZIP2形式で圧縮|
|`-tgzip`|GZIP形式で圧縮|
|`-x!*.txt`|`.txt`ファイルを除外して圧縮|
|`-r`|サブディレクトリも再帰的に圧縮|
|`-snl`|改行コードを変換しない|
|`-mmt`|マルチスレッドを利用して圧縮速度を向上させる|
|`--`|以降の引数をオプションではなくファイル名として解釈する。 `*` のようなワイルドカードを使うときに便利。|

## リストファイル

圧縮・解凍するファイルやフォルダのリストを記載したテキストファイル。 `7z` コマンドはそのファイルに記載されたリストに基づいて処理を行う。

リストファイル名の先頭には `@` がつく。

## exploitでの利用

[https://book.hacktricks.xyz/linux-hardening/privilege-escalation/wildcards-spare-tricks#id-7z](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/wildcards-spare-tricks#id-7z)

リストファイルとシンボリックリンクを利用して任意のファイルを閲覧することができるのでSSH秘密鍵の取得などに利用可能。

# Brace Expansion

シェルにおいて中括弧を用いることで特定のパターンを簡潔に記述し、複数の文字列を一度に生成することができる。

`{}` の中にカンマで区切った値を書くだけでそれぞれの値が展開される。OSコマンドインジェクションのペイロードに利用可能。

```bash
echo {a,b,c}
>>>
a b c
```

`{START..END}` の形式で連続した数値を生成できる。

```bash
echo {1..5}
>>>
1 2 3 4 5
```

アルファベットも同様に展開できる。

```bash
echo {a..e}
>>>
a b c d e
```

`{START..END..STEP}` でステップ値を指定して展開できる。アルファベットにも利用可能。

```bash
echo {1..10..3}
>>>
1 4 7 10

echo {a..z..3}
>>>
a d g j m p s v y
```

中括弧を複数重ねて使うとすべての組み合わせが生成される。

```bash
echo {a,b}{1,2,3}
>>>
a1 a2 a3 b1 b2 b3
```
# tr

テキストデータの文字列に対して処理をするコマンド。コピペして作成したファイルから改行を削除したいときなどに有効。

```bash
# 文字の置き換え
echo "hello" | tr 'a-z' 'A-Z'
>>>
HELLO

# 特定の文字を削除
echo "hello 123" | tr -d '0-9'
>>>
hello

# 連続する文字の圧縮
echo "aaabbbbcc" | tr -s 'a-z'
>>>
abc

# スペースを改行に変換
echo "hello world" | tr ' ' '\\n'
>>>
hello
world

# テキストファイル内の改行を削除
tr -d '\\n' < TEXT_FILE
```

|オプション|説明|
|---|---|
|-d|指定した文字を削除|
|-s|連続した文字を圧縮|
|-c|指定したセットの補集合を対象にする|

# mount

ファイルシステムを特定のディレクトリに接続(mount)するコマンド。これによりストレージデバイスやリモートファイルシステムの内容を、システム内のディレクトリを通じてアクセスできるようになる。

```bash
mount OPTIONS DEVICE_PATH MOUNT_POINT

# NFSなどのリモートファイルシステムをマウント
sudo mount -t nfs REMOTE_IP:REMOTE_DIRECTORY MOUNT_POINT
```

`DEVICE_PATH` には接続するデバイスのパスを、 `MOUNT_POINT` にはデバイスをマウントするディレクトリを入れる。

NFSには認証/認可の概念が存在しないので、一旦マウントすれば当該マウントファイルシステム内のパーミッション(UIDやGID)と同じパーミッションを持つアカウントを作成することでアクセスができる。

オプション

|オプション|説明|
|---|---|
|-t|ファイルシステムタイプを引数に取る(ext4, vfat, nfsなど)|

## showmount

NFSサーバがエクスポートしているディレクトリ情報を表示するコマンド。

```bash
showmount OPTIONS SERVER_NAME
```

`SERVER_NAME` にはNFSサーバのホスト名またはIPアドレスが入る。省略するとローカルのNFSサーバとなる。

オプション

|オプション|説明|
|---|---|
|-e|エクスポートされているディレクトリ一覧を表示|
|-a|すべてのマウント状況を表示|
|-d|ディレクトリごとのマウント情報を表示|

# シェル設定ファイル

シェルの動作や環境をカスタマイズするスクリプト。エイリアスや環境変数、プロンプトのカスタマイズなどが行われる。

## .bashrc

対話的なシェルセッションの開始時に実行される。各ユーザのホームディレクトリ( `~/.bashrc` )に存在。

## .bash_profile

ログインシェルが起動する際に実行される。各ユーザのホームディレクトリに存在。セッション開始時に一度だけ読み込まれる。

## .bash_logout

シェルセッションが終了する際に実行される。各ユーザのホームディレクトリに存在。セッション終了時の後片付け(一時ファイルの削除など)に利用されることが多い。

## /etc/profile

全ユーザに適用されるログインシェルの設定を行う。システムレベルの設定なのでユーザ全員に適用される。 `.bash_profile` よりも先に読み込まれる。

## /etc/bash.bashrc

全ユーザに適用される対話シェルの設定を行う。

# dig

DNS関連の情報を取得するコマンド。

```bash
dig DOMAIN RECORD_TYPE

# 特定のIPアドレスを指定して問い合わせる
dig @IP_ADDRESS DOMAIN

# 逆引き(IPアドレスからドメイン情報を取得)
dig -x IP_ADDRESS
```

`RECORD_TYPE` は省略するとAレコード(IPv4)が返される。

レコードタイプ

|レコードタイプ|説明|
|---|---|
|A|IPv4|
|AAAA|IPv6|
|MX|メールサーバ|
|NS|ネームサーバ|
|TXT|テキスト情報|
|CNAME|エイリアス|

## ゾーン転送要求

ゾーンデータ(DNSサーバの管理するドメインとIPアドレスの対応情報)の転送を要求する。通常ゾーン転送はDNSサーバ間で行われ外部に転送することはないが、設定ミス等により転送が許可されている場合がある。ペネトレーションテストにおいては対象ドメインのサブドメイン情報を収集するために利用できる可能性がある。

```bash
dig @IP_ADDRESS ZONE_NAME AXFR
```

`IP_ADDRESS` にはDNSサーバ自身のIPアドレスを指定する。ZONE_NAMEはゾーン転送の対象のドメインを指定する。 `AXFR` は完全ゾーン転送の要求を意味する。

# ヒアドキュメント

指定された文字列が現れるまでの入力をすべて受け取りcatコマンドに渡す。

```bash
cat > test.txt << "EOF"
```

上の例では `EOF` という文字列が現れるまでの入力を受けとり、catコマンドに渡す。文字列は何でも良いが `EOF` にするのが慣例。

`<< "EOF"` のようにダブルクウォートを使用すると変数展開が有効になり、 `<< 'EOF'` のようにシングルクォートにすると変数展開が無効になるので基本前者のほうが良い。

# Audit Log

システムのセキュリティ監査を行うためのログ。システムのアクセス制御・認証・権限変更・コマンド実行などのイベントを記録する。TTY inputも記録している場合があるので入力された認証情報をログから取得できる可能性がある。

## aureport

auditログを出力するコマンド。

```bash
aureport --tty
```

# UFW

Uncomplicated Firewall.

iptablesを簡単に管理できるファイアウォールツール。実行には管理者権限が必要。

```bash
# UFWの状態を確認
sudo ufw status

# UFWを有効化
sudo ufw enable

# UFWを無効化
sudo ufw disable

# ポート22へのインバウンド通信を許可
sudo ufw allow 22

# ポート80へのTCPによるインバウンド通信を許可
sudo ufw allow 80/tcp

# ポート8080へのインバウンド通信をブロック
sudo ufw deny 8080

# IPアドレス192.168.1.100からのアクセスをすべて許可
sudo ufw allow from 192.168.1.100

# IPアドレス192.168.1.100からのポート22へのアクセスを許可
sudo ufw allow from 192.168.1.100 to any port 22

# 192.168.1.0/24のサブネットからのアクセスを許可
sudo ufw allow from 192.168.1.0/24\\

# ポート22の許可を削除
sudo ufw delete allow 22

# すべてのルールをリセット
sudo ufw reset

# ポート25のアウトバウンド通信をブロック
sudo ufw deny out 25
```

ポート番号ではなく `/etc/services` に定義されたサービス名を使って設定することもできる。

# lsof

List Open Files.

「開いているファイル」を一覧表示するコマンド。Linuxではファイルだけでなくプロセスが使用するソケットやパイプなども含めすべてがファイトして扱われるのでこれらも一覧表示の対象となる。

```bash
# システム上のすべての開いているファイルを表示
lsof

# 特定のプロセスが開いているファイルを表示
lsof -p PID

# 特定のユーザが開いているファイルを表示
lsof -u USER_NAME

# 特定のファイルを開いているプロセスを表示
lsof FILE_PATH

# 特定のポートを使用しているプロセスを表示
lsof -i:PORT_NUMBER

# ネットワーク接続を待つプロセスを表示
lsof -i

# 特定のコマンド名のプロセスが開いているファイルを表示
lsof -c COMMAND

# 特定のディレクトリ以下のファイルを開いているプロセスを表示
lsof +D DIRECTORY_PATH

# 削除されたがまだ開いているファイルを表示
lsof | grep deleted

# 開いているすべてのソケットを表示
lsof -i -n -P
```

`-n` オプションでホスト名の名前解決を行わないようにする(高速化)。 `-P` オプションでポート番号を名前に変換しないようにする。

出力例

```bash
COMMAND     PID   USER   FD   TYPE     DEVICE  SIZE/OFF    NODE NAME
nginx      1234   root   4u   IPv4     123456  0t0         TCP  *:80 (LISTEN)
```

|項目名|説明|
|---|---|
|COMMAND|プロセスの実行コマンド|
|PID|プロセス ID|
|USER|実行ユーザー|
|FD|ファイルディスクリプタ（例: `u` = 読み書き, `r` = 読み取り専用）|
|TYPE|ファイルの種類（例: `REG` = 通常ファイル, `DIR` = ディレクトリ, `IPv4` = ネットワークソケット）|
|DEVICE|デバイス番号|
|SIZE/OFF|ファイルサイズまたはオフセット|
|NODE|ノード番号|
|NAME|ファイルやネットワークソケットの名前|

# MOTD

Message Of The Day.

ユーザがログインした際に表示されるメッセージ。通常 `/etc/motd` ファイルに静的なメッセージを書いておくことで設定できるが、一部のディストリビューションではMOTDを動的に生成するために `/etc/update-motd.d` が使用される。

例えばubuntuのデフォルト設定では以下のようなファイルが後者のディレクトリに含まれる。

|ファイル名|役割|
|---|---|
|`00-header`|システム情報の表示（ホスト名、OS情報）|
|`10-help-text`|ヘルプ情報の表示|
|`50-motd-news`|Ubuntu の公式ニュースを取得して表示|
|`80-esm`|Ubuntu Pro (旧称: ESM) に関する情報|
|`90-updates-available`|パッケージの更新情報を表示|
|`91-release-upgrade`|OSの新しいリリースが利用可能か確認|
|`95-hwe-eol`|ハードウェアサポートの期限を通知|
|`98-fsck-at-reboot`|次回再起動時に `fsck` が実行されるか通知|
|`99-footer`|フッターの表示|

これらのファイルはシェルスクリプトであり、ファイル名の番号順に実行される。各スクリプトの出力が `/run/motd.dynamic` に統合され、ユーザがログインした際にこの統合ファイルの内容が表示される。

# cut

テキストデータを分割して一部のデータを抽出するコマンド。

```bash
cut OPTIONS FILE_NAME
```

オプション

|オプション|説明|使用例|
|---|---|---|
|`-b`|バイト単位で抽出|`cut -b 1-5 file.txt` → 各行の1～5バイト目を取得|
|`-c`|文字単位で抽出|`cut -c 3-7 file.txt` → 各行の3～7文字目を取得|
|`-f`|フィールド（列）単位で抽出|`cut -d "," -f 2 file.csv` → `,` 区切りの2列目を取得|
|`-d`|フィールドの区切り文字を指定|`cut -d ":" -f 1 /etc/passwd` → `:` 区切りの1列目を取得|
|`--complement`|指定したフィールド以外を取得|`cut -d ":" -f 1 --complement /etc/passwd`|
|`-s`|区切り文字がない行を無視|`cut -d ":" -f 2- /etc/passwd -s`|

# tee

標準入力から受け取ったデータを標準出力に表示しつつファイルにも書き込むことができるコマンド。

```bash
tee OPTIONS OUTPUT_FILE
```

オプション

|オプション|説明|
|---|---|
|`-a`|既存のファイルに追記（上書きせず追加）|
|`-i`|`SIGINT`（Ctrl + C）を無視|
|`-p`|出力エラーが発生した場合も処理を続行（GNU版のみ）|

# その他Tips

## ユーザ入力の処理

`[[ ... ]]` の中ではワイルドカードを用いることができる。

```bash
if [[ $VAR1 == $VAR2 ]]; then ...
```

上のスクリプトにおいて、例えば `$VAR1` の値が `a` 、 `$VAR2` の値が `*` のとき、比較演算子は `True` を返す。

|オプション|説明|
|---|---|
|`-n`|グループ名を変更|
|`-g`|グループID（GID）を変更|

## シェルスクリプトの構文

### シバン(Shebang)

シェルスクリプトの冒頭で書かれることが多い文。スクリプトが実行されるシェルを指定する。

```bash
#!/bin/bash
```

冒頭にShebangを書くことでスクリプトを実行するインタープリタをシステム側に伝えることができるのでコマンドラインでインタープリタを明示する必要がなくなる。

```bash
# SheBang(!#/usr/bin/python3 など)があるpythonスクリプトの場合
./script.py

# SheBangがない場合はコマンドラインでインタープリタを指定する必要がある
python3 script.py
```

### シェル設定ファイルの読み込み

`.` は `source` を省略したもの。

```bash
source ~/.bashrc
. ~/.bashrc
```

### enable

シェル組み込みコマンドの有効/無効化を設定する。

```bash
enable OPTIONS BUILD_IN_COMMAND
```

オプション

|オプション|説明|
|---|---|
|-n|コマンドを無効化|

### [

`test` コマンドのエイリアス。条件式の評価に用いられる。条件式を評価し、真であれば終了ステータス(0)、偽であれば(1)を返す。

```bash
if [ -f /etc/passwd ]; then
  echo "ファイルが存在します"
else
  echo "ファイルが存在しません"
fi
```

上記のスクリプトでは `[` は `test` と同じであり、 `-f` はファイルの存在をチェックする。

`[` の直後と `]` の直前にはスペースが必要なことに注意。

### [[

`[` の拡張版。条件の評価にワイルドカードや正規表現を用いることができる。

## コマンド実行時の環境変数

コマンドの前に環境変数を指定して実行することができる。コマンドが終了すると環境変数はもとに戻る。

```bash
ENV=XXX COMMAND

# 例
PATH=$PWD:$PATH COMMAND
```

## 改行と空白文字の削除

コピーした秘密鍵をペーストしてファイルを作る際などに有効。

```bash
echo "STRING" | tr -d '\\n ' > output.txt
```

## 任意のディレクトリ内のファイルを一括ダウンロード

```bash
wget -r -np --cut-dirs=1 -A '*.acc' http://DOMAIN_NAME/
```

`-r`で再帰的にダウンロード。 `-np` で親ディレクトリには遡らない。 `--cut-dirs`でホスト名の後の最初のディレクトリを切る。 `-A`で指定したパターンに一致するファイルだけを取得対象にする。

上の例だと `http://DOMAIN_NAME/DIR/xxx.txt`はコマンドを実行したディレクトリに `DOMAIN_NAME/xxx.txt` として保存される。

`-nH`オプションを付けるとカレントディレクトリにホスト名のディレクトリが作られない。